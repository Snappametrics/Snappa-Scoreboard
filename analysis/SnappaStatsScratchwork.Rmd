---
title: "Snappa Stats Scratchwork"
output: html_notebook
---


```{r setup, message=F}
library(DBI)
library(RPostgres)
library(tidyverse)
library(shiny)
library(lubridate)
library(dbplyr)
library(shinyjs)
library(shinyWidgets)
library(gt)
library(extrafont)
library(gghighlight)
library(ggrepel)
library(patchwork)
library(ggimage)


source("dbconnect.R")
source("ui_functions.R")

# Round numbers and labels
rounds = str_c(rep(1:100, each = 2), rep(c("A", "B"), 100))
round_labels = rep(c("Pass the dice", "Next round"),100)

# Pull db tables for tibble templates
players_tbl = tbl(con, "players") %>% collect()
scores_tbl = tbl(con, "scores") %>% collect()
player_stats_tbl = tbl(con, "player_stats") %>% collect()
game_stats_tbl = tbl(con, "game_stats") %>% collect()

# Identify the last game
last_game = max(scores_tbl$game_id)

player_info = player_stats_tbl %>% 
  # Filter player stats
  filter(game_id == last_game) %>% 
  select(game_id, player_id, team) %>% 
  left_join(players_tbl)


```


# An Analysis of a Game

One of the fundamental aims of the SnappaScoreboard is to provide players some analysis of their performance in a game.
We want to look at how many points a player has scored, how they have scored them, and how frequently they scored.

## Game Flow

To visualize **_game flow_**, we join the `player_stats` table to the `scores` table in order to get a dataframe which tracks each player's cumulative score throughout the game.

```{r}
player_scores = scores_tbl %>% 
  # Join the scores table to the player info
  inner_join(player_info, by = c("game_id", "player_id")) %>% 
  # Convert round_num into the actual round id
  rowwise() %>% 
  mutate(round = which(rounds == round_num)) %>% 
  ungroup() %>% 
  # Sort by game and score
  arrange(game_id, score_id) %>% 
  # Calculate each player's cumulative score throughout the game
  group_by(player_id) %>% 
  mutate(cum_score = cumsum(points_scored))

head(player_scores)
```

I wanted to show where each player started scoring, and give players a baseline of 0 points to start from.
I think this makes the visualization look a lot cleaner.
In order to do this, we can make a separate little utility dataframe.

```{r}

# TODO: Track sinks and use them to insert a little image where sinks are scored
# sinks = player_scores %>% 
#   filter(points_scored == 3) %>% 
#   mutate(sink_splash = list.files("www", pattern="png", full.names = T),
#          sink_position = cum_score - 1.5)

# Add zeroes => everyone has to start somewhere
player_score_base = player_scores %>% 
  group_by(game_id, player_id, player_name, team) %>% 
  summarise(round = min(round)-1, 
            points_scored = 0, 
            cum_score = 0)

head(player_score_base)

```

Another little utility dataframe that I make is a subset of the data which we want to use to label the player names, in this case, each player's final score.

```{r}
player_label_df = player_scores %>% 
  filter(cum_score == max(cum_score)) %>% 
  select(player_name, player_id, team, round, cum_score)

head(player_label_df)
```
Before we make the plot, we calculate the max score and round for the scales and join in the zeroes utility dataframe.

```{r}

# Calculate max values for scales
max_score = max(player_scores$cum_score)
max_round = max(player_scores$round)

game_flow_df = player_scores %>% 
    bind_rows(player_score_base)

head(game_flow_df)
```

And now, the plot!

```{r}

# img <- list.files("www",
#                   pattern="png", full.names=TRUE)

# game_flow_df = player_scores %>% 
#     bind_rows(player_score_base) %>% 
#   mutate(sink_image = case_when(points_scored == 3 ~ img,
#                            T ~ NA_character_))

# sinks = filter(game_flow_df, !is.na(sink_image))

game_flow_plot = game_flow_df %>% 
    ggplot(., aes(x = round, y = cum_score))+
    geom_line(aes(group = player_id, colour = team), size = 1, show.legend = F, alpha = .8)+
    geom_label_repel(data = player_label_df,
                    aes(group = player_id, colour = team, label = player_name),
                    size = 5, label.padding = .15, box.padding = .15, label.size = NA, fill = snappa_pal[1],
                    nudge_x = 1.25, nudge_y = .5, force = .35, show.legend = F, segment.alpha = 0)+
    # geom_image(data = filter(game_flow_df, !is.na(sink_image)))+
    scale_y_continuous(name = "Points", 
                       breaks = scales::breaks_pretty(n = 5), 
                       limits = c(0, max_score+5-(max_score%%5)),
                       expand = expansion())+
    scale_x_continuous(name = "Round", 
                       breaks = scales::breaks_pretty(n =10), 
                       limits = c(0, max_round+5),
                       expand = expansion())+
    scale_colour_manual(values = c("A" = "#e26a6a", "B" = "#2574a9"))+
    labs(title = "How the die flies",
         subtitle = "Players' point progression")+ #<img src = "www/sink.png" width="30px" height="30px">
    theme_snappa(plots_pane = T, md=T)

# mtcars %>% 
#   mutate(image = case_when(hp == max(hp) ~ img,
#                            T ~ NA_character_)) %>% 
#   ggplot(., aes(x = mpg, y = hp, colour = cyl))+
#     geom_point()+
#   geom_image(aes(image = image))

game_flow_plot
```

## Game summary table

```{r game-summary-fun}

tab_theme_snappa = function(data, 
                     # Container
                     container.width = pct(95), 
                     container.height = pct(50), 
                     container.overflow.x = NULL, 
                     container.overflow.y = NULL, 
                     # Table
                     table.width = NULL, table.layout = NULL, table.align = NULL, 
                     table.margin.left = NULL, table.margin.right = NULL, table.background.color = NULL, 
                      table.additional_css = NULL, table.font.names = NULL, table.font.size = NULL, 
                      table.font.weight = NULL, table.font.style = NULL, table.font.color = NULL, 
                      table.font.color.light = NULL, 
                     table.border.top.style = "none",table.border.top.width = NULL, table.border.top.color = NULL, 
                      table.border.right.style = "none", table.border.right.width = NULL,table.border.right.color = NULL, 
                     table.border.bottom.style = "none",table.border.bottom.width = NULL, table.border.bottom.color = NULL, 
                      table.border.left.style = "none", table.border.left.width = NULL,table.border.left.color = NULL, 
                     # Heading
                     heading.background.color = NULL, 
                      heading.align = NULL, 
                     heading.title.font.size = NULL, heading.title.font.weight = NULL, 
                      heading.subtitle.font.size = NULL, heading.subtitle.font.weight = NULL, 
                      heading.border.bottom.style =  "none", heading.border.bottom.width = NULL, heading.border.bottom.color = NULL, 
                     heading.border.lr.style = "none", heading.border.lr.width = NULL, heading.border.lr.color = NULL, 
                     # Column labels
                      column_labels.background.color = NULL, 
                     column_labels.font.size = NULL, column_labels.font.weight = NULL, 
                     column_labels.text_transform = NULL, 
                      column_labels.vlines.style = NULL, column_labels.vlines.width = NULL, column_labels.vlines.color = NULL,
                     column_labels.border.top.style =  "none", column_labels.border.top.width = NULL, column_labels.border.top.color = NULL, 
                     column_labels.border.bottom.style = "solid", column_labels.border.bottom.width = "3px", column_labels.border.bottom.color = "#7c7c7c", 
                     column_labels.border.lr.style = "none", column_labels.border.lr.width = NULL, column_labels.border.lr.color = NULL, 
                      column_labels.hidden = NULL, 
                     # Row group
                     row_group.background.color = NULL, 
                      row_group.font.size = NULL, row_group.font.weight = NULL, 
                      row_group.text_transform = NULL, row_group.padding = NULL, 
                      row_group.border.top.style = NULL, row_group.border.top.width = NULL, 
                      row_group.border.top.color = NULL, row_group.border.bottom.style = NULL, 
                      row_group.border.bottom.width = NULL, row_group.border.bottom.color = NULL, 
                      row_group.border.left.style = NULL, row_group.border.left.width = NULL, 
                      row_group.border.left.color = NULL, row_group.border.right.style = NULL, 
                      row_group.border.right.width = NULL, row_group.border.right.color = NULL, 
                     # Table body
                      table_body.hlines.style = NULL, table_body.hlines.width = NULL, 
                      table_body.hlines.color = NULL, 
                     table_body.vlines.style = NULL, 
                      table_body.vlines.width = NULL, table_body.vlines.color = NULL, 
                      table_body.border.top.style = NULL, table_body.border.top.width = NULL, table_body.border.top.color = "#DEDDDD", 
                     table_body.border.bottom.style = NULL, table_body.border.bottom.width = NULL, table_body.border.bottom.color = "#DEDDDD", 
                     # Stub
                      stub.background.color = NULL, stub.font.size = NULL, stub.font.weight = NULL, 
                      stub.text_transform = NULL, stub.border.style = NULL, stub.border.width = NULL, 
                      stub.border.color = NULL, 
                     data_row.padding = NULL, 
                     # Summary row
                     summary_row.background.color = NULL, 
                      summary_row.text_transform = NULL, summary_row.padding = NULL, 
                      summary_row.border.style = NULL, summary_row.border.width = NULL, 
                      summary_row.border.color = NULL, 
                     # Grand summary row
                     grand_summary_row.background.color = NULL, 
                      grand_summary_row.text_transform = NULL, grand_summary_row.padding = NULL, 
                      grand_summary_row.border.style = NULL, grand_summary_row.border.width = NULL, 
                      grand_summary_row.border.color = NULL, 
                     # Footnotes
                     footnotes.background.color = NULL, 
                      footnotes.font.size = NULL, footnotes.padding = NULL, footnotes.border.bottom.style = NULL, 
                      footnotes.border.bottom.width = NULL, footnotes.border.bottom.color = NULL, 
                      footnotes.border.lr.style = NULL, footnotes.border.lr.width = NULL, 
                      footnotes.border.lr.color = NULL, footnotes.sep = NULL, footnotes.marks = NULL, 
                     # Source notes
                      source_notes.background.color = NULL, source_notes.font.size = NULL, 
                      source_notes.padding = NULL, source_notes.border.bottom.style = NULL, 
                      source_notes.border.bottom.width = NULL, source_notes.border.bottom.color = NULL, 
                      source_notes.border.lr.style = NULL, source_notes.border.lr.width = NULL, 
                      source_notes.border.lr.color = NULL, 
                     # Row striping
                     row.striping.background_color = NULL, 
                      row.striping.include_stub = NULL, row.striping.include_table_body = NULL){
    gt:::stop_if_not_gt(data = data)
    opts_df <- gt:::dt_options_get(data = data)
    arg_names <- formals(tab_options) %>% names() %>% base::setdiff("data")
    arg_vals <- mget(arg_names)
    arg_vals <- arg_vals[!vapply(arg_vals, FUN = is.null, FUN.VALUE = logical(1))]
    arg_vals <- arg_vals %>% gt:::set_super_options()
    
    new_df <- dplyr::tibble(parameter = names(arg_vals) %>% 
                              gt:::tidy_gsub(".", "_", fixed = TRUE), value = unname(arg_vals)) %>%
      dplyr::left_join(opts_df %>% 
                         dplyr::select(parameter, type), by = "parameter") %>% 
      dplyr::mutate(value = mapply(gt:::preprocess_tab_option, option = value, 
                                   var_name = parameter, type = type, SIMPLIFY = FALSE)) %>% 
      dplyr::select(-type)
    
    opts_df <- dplyr::bind_rows(new_df %>% 
                                  dplyr::inner_join(opts_df %>% 
                                                      dplyr::select(-value), by = "parameter"), opts_df %>% 
                                  dplyr::anti_join(new_df, by = "parameter"))
    
    data <- gt:::dt_options_set(data = data, options = opts_df)
    data
}


team_summary_tab = function(df, team){
  winners = unique(df$winners)
  title_colour = if_else(unique(df$team) == "A", snappa_pal[2], snappa_pal[3])
  
  hide_diff_cols = head(df, 1) %>% # Take the first row of a column
    mutate_all(as.character) %>% # prevents errors in pivot_longer
    # convert to column-value pair dataframe
    pivot_longer(everything(), names_to = "column", values_to = "value") %>% 
    # remove the value
    select(-value) %>% 
    # Craft the desired label
    # Below I remove the year, replace underscores with spaces, and convert to title case
    mutate(label = case_when(
      # column == "player_name" ~ "Player",
      # column == "total_points" ~ "Total Points",
      # column == "paddle_points" ~ "Paddle Points",
      # column == "clink_points" ~ "Clink Points",
      # column == "sinks" ~ "Sinks", # TODO: Fix this 
      # column == "points_per_round" ~ "Points per Round\n(PPR)",
      # column == "off_ppr" ~ "Offensive PPR",
      # column == "def_ppr" ~ "Defensive PPR",
      # column == "toss_efficiency" ~ "Toss Efficiency",
      # T ~ ""
      column == "player_name" ~ "Player",
      str_detect(column, "_diff$") ~ "Diff.",
      T ~ ""
    )) %>% 
    # Deframe to named vector
    deframe()
  
  df %>% 
    arrange(-total_points) %>% 
    gt(.) %>% 
    tab_header(title = str_c("Team ", team),
               subtitle = if_else(winners, "the winners.", "the losers.")) %>% 
    cols_hide(columns = vars(player_id, team, winners)) %>% 
    # Column names
    cols_label(
      # player_name = "Player",
      # total_points = "Total Points",
      # paddle_points = "Paddle Points",
      # clink_points = "Clink Points",
      # sinks_total = "Sinks", # TODO: Fix this
      # points_per_round = "Points per Round\n(PPR)",
      # off_ppr = "Offensive PPR",
      # def_ppr = "Defensive PPR",
      # toss_efficiency = "Toss Efficiency",
      .list = hide_diff_cols
    ) %>%
    # Format integers
    fmt_number(
      columns = vars(total_points, paddle_points, clink_points, sinks),
      decimals = 0
    ) %>% 
    # Format doubles
    fmt_number(
      columns = vars(points_per_round, off_ppr, def_ppr),
      decimals = 2
    ) %>% 
    # Format percentages
    fmt_percent(
      columns = vars(toss_efficiency),
      decimals = 0
    ) %>% 
    # Styling
    # Title
    tab_style(
      style = list(cell_text(weight = "bold", size = px(20), color = title_colour)),
      locations = cells_title(groups = "title")
    ) %>%
    # Subtitle
    tab_style(style = cell_text(align = "left", v_align = "bottom"),
              locations = list(cells_title("title"), cells_title("subtitle"))) %>% 
    # Colour stat differences
    ## Positive
    tab_style(style = cell_text(color = snappa_pal[5]),
              locations = list(
                cells_body(columns = vars(total_points_diff), rows = str_detect(total_points_diff, "\\+")),
                cells_body(columns = vars(paddle_points_diff), rows = str_detect(paddle_points_diff, "\\+")),
                cells_body(columns = vars(clink_points_diff), rows = str_detect(clink_points_diff, "\\+")),
                cells_body(columns = vars(points_per_round_diff), rows = str_detect(points_per_round_diff, "\\+")),
                cells_body(columns = vars(off_ppr_diff), rows = str_detect(off_ppr_diff, "\\+")),
                cells_body(columns = vars(def_ppr_diff), rows = str_detect(def_ppr_diff, "\\+")),
                cells_body(columns = vars(toss_efficiency_diff), rows = str_detect(toss_efficiency_diff, "\\+"))
                )
              ) %>% 
    ## Negative
    tab_style(style = cell_text(color = snappa_pal[2]),
              locations = list(
                cells_body(columns = vars(total_points_diff), rows = str_detect(total_points_diff, "\\-")),
                cells_body(columns = vars(paddle_points_diff), rows = str_detect(paddle_points_diff, "\\-")),
                cells_body(columns = vars(clink_points_diff), rows = str_detect(clink_points_diff, "\\-")),
                cells_body(columns = vars(points_per_round_diff), rows = str_detect(points_per_round_diff, "\\-")),
                cells_body(columns = vars(off_ppr_diff), rows = str_detect(off_ppr_diff, "\\-")),
                cells_body(columns = vars(def_ppr_diff), rows = str_detect(def_ppr_diff, "\\-")),
                cells_body(columns = vars(toss_efficiency_diff), rows = str_detect(toss_efficiency_diff, "\\-"))
                )
              ) %>% 
    # Column spanners
    tab_spanner(
      label = "Total Points",
      columns = contains("total_points")
    ) %>% 
    tab_spanner(
      label = "Paddle Points",
      columns = contains("paddle")
    ) %>% 
    tab_spanner(
      label = "Clink Points",
      columns = contains("clink")
    ) %>% 
    tab_spanner(
      label = "Sinks",
      columns = contains("sink")
    ) %>% 
    tab_spanner(
      label = "Pts per Round",
      columns = contains("per_")
    ) %>% 
    tab_spanner(
      label = "Off. PPR",
      columns = contains("off_")
    ) %>% 
    tab_spanner(
      label = "Def. PPR",
      columns = contains("def_")
    ) %>% 
    tab_spanner(
      label = "Toss Efficiency",
      columns = contains("toss")
    ) %>% 
    tab_source_note("Comparison of current game to career average") %>% 
    tab_source_note(md(str_c('<span style="font-size: 18px;font-weight: 700;color:', snappa_pal[2], ';">Snappa</span>',
                             '<span style="font-size: 18px;font-weight: 700;color:', snappa_pal[4], ';">DB</span>'))) %>% 
    # Footnotes
    # tab_footnote(
    #   footnote = "Defensive points are scored from paddles.",
    #   locations = cells_column_spanners("Def. PPR")#cells_column_labels(columns = vars(def_ppr))
    # ) %>% 
    # tab_footnote(
    #   footnote = "% of tosses which are successful.",
    #   locations = cells_column_spanners("Toss Efficiency")#cells_column_labels(columns = vars(toss_efficiency))
    # ) %>%
    # opt_footnote_marks(marks = "letters") %>% 
    # Styling
    tab_style(
      style = cell_text(weight = 600, size = px(15), v_align = "bottom"),
      locations = map(c("Total Points","Paddle Points","Clink Points","Sinks","Pts per Round","Off. PPR","Def. PPR","Toss Efficiency"),
                      cells_column_spanners)
    ) %>% 
    tab_style(
      style = cell_text(size = px(14)),
      locations = cells_column_labels(everything())
    ) %>% 
    cols_align(align = "right", 
               columns = colnames(df) %>% str_subset("player_name", negate = T)) %>% 
    # Left Align player
    cols_align(align = "left", 
               columns = c("player_name")) %>%
    tab_style(
      style = cell_text(align = "left"),
      locations = cells_column_labels(columns = vars(player_name))
    ) %>% 
    # Column widths
    cols_width(
      vars(player_name) ~pct(7),#px(120),
      vars(total_points, paddle_points, clink_points) ~ pct(3), 
      vars(points_per_round, off_ppr, def_ppr) ~ pct(4),
      vars(toss_efficiency, sinks) ~ pct(5),#px(60),
      ends_with("points_diff") ~ pct(5),#px(50),
      matches("(per_round|ppr|efficiency)_diff$") ~ pct(6)#px(55),
    ) %>% 
    tab_theme_snappa()
}


```

```{r game-summary-data}
player_summary = player_stats_tbl %>% 
  # Select the last game
  filter(game_id == last_game) %>% 
  group_by(team) %>% 
  mutate(team_score = sum(total_points)) %>% 
  ungroup() %>% 
  mutate(winners = (team_score == max(team_score))) %>% 
  # Merge in player info
  inner_join(player_info) %>% 
  select(team, winners, player_id, player_name, total_points, paddle_points, clink_points, threes, points_per_round:toss_efficiency)

historical_stats = player_stats_tbl %>% 
    select(-team) %>% 
  # Select all games prior to the last game
    filter(game_id < last_game) %>% 
  # Join in player name
    inner_join(select(player_summary, player_id, team)) %>%
    arrange(player_id, game_id) %>% 
    group_by(player_id) %>% 
    mutate(game_num = 1:n()) %>% 
    ungroup() %>% 
    select(game_id, player_id, shots, total_points, paddle_points, clink_points, sinks = threes, points_per_round:toss_efficiency) %>% 
    group_by(player_id) %>% 
    summarise(
        across(.cols = c(total_points, paddle_points, clink_points), .fns = mean, .names = "{col}_avg"),
        across(.cols = c(sinks), .fns = sum, .names = "{col}_total"),
        across(.cols = c(points_per_round, off_ppr, def_ppr, toss_efficiency),
               .fns = ~weighted.mean(., w = shots), 
               .names = "{col}_wavg")
    )

toss_percent_plus = function(x){
  str_c("(+", round(x*100, 0), "%)")
}
toss_percent_minus = function(x){
  str_c("(", round(x*100, 0), "%)")
}

player_summary_historical = full_join(player_summary, historical_stats, by = "player_id") %>% 
  # Calculate the difference between current game and historical performance
    mutate(total_points_diff = total_points - total_points_avg,
           paddle_points_diff = paddle_points - paddle_points_avg,
           clink_points_diff = clink_points - clink_points_avg,
           points_per_round_diff = points_per_round - points_per_round_wavg,
           off_ppr_diff = off_ppr - off_ppr_wavg,
           def_ppr_diff = def_ppr - def_ppr_wavg,
           toss_efficiency_diff = toss_efficiency - toss_efficiency_wavg,
           # Format each difference for the table
           across(matches("points_diff"), ~str_c("(", if_else(.x >= 0, "+", ""), round(.x, 1), ")")),
           across(matches("(per_round|ppr)_diff$"), ~str_c("(", if_else(.x >= 0, "+", ""), round(.x, 2), ")")),
           toss_efficiency_diff = map_chr(toss_efficiency_diff, ~case_when(. >= 0 ~ toss_percent_plus(.), 
                                                                           . < 0 ~ toss_percent_minus(.)))) %>%
  # Remove historical stats
    select(-ends_with("_avg"), -ends_with("wavg")) %>% 
  # Order columns
    select(starts_with("player"), team, winners, 
           contains("total_points"), contains("paddle"), contains("clink"), sinks = threes, 
           contains("per_round"), contains("off_"), contains("def_"), contains("toss")) 


```

```{r game-summary-output}

a_summary = player_summary_historical %>% 
  filter(team == "A") %>% 
  team_summary_tab(team = "A")

b_summary = player_summary_historical %>% 
  filter(team == "B") %>% 
  team_summary_tab(team = "B")

player_summary_historical %>% 
  group_split(team) %>% 
  set_names(c("A", "B")) %>% 
  imap(~team_summary_tab(.x, team = .y))
```




# Stats Pane

## Snappaneers Leaderboard

```{r}
leaderboard_table = function(df){
  df %>% 
    select(rank, player_name, games_played, win_pct, total_points, total_shots, points_per_game, off_ppg, def_ppg, toss_efficiency) %>% 
    gt(., id = "leaderboard") %>% 
    tab_header(title = "Snappaneers Leaderboard", 
               subtitle = "The Deadliest Die-throwers in all the land.") %>% 
    # Column names
    cols_label(
      rank = "", 
      player_name = "Player",
      games_played = "Games Played",
      win_pct = "Win %", 
      total_points = "Total Points",
      total_shots = "Total Shots",
      points_per_game = "Points per Game\n(PPG)",
      off_ppg = "Offensive PPG",
      def_ppg = "Defensive PPG",
      toss_efficiency = "Toss Efficiency"
    ) %>% 
    # Format integers
    fmt_number(
      columns = vars(rank, total_points, total_shots),
      decimals = 0
    ) %>% 
    # Format doubles
    fmt_number(
      columns = vars(points_per_game, off_ppg, def_ppg),
      decimals = 2
    ) %>% 
    # Format percentages
    fmt_percent(
      columns = vars(win_pct, toss_efficiency),
      decimals = 0
    ) %>% 
    tab_footnote(
      footnote = "Defensive points are scored from paddles.",
      locations = cells_column_labels(columns = vars(def_ppg))
    ) %>% 
    tab_footnote(
      footnote = "% of tosses which are successful.",
      locations = cells_column_labels(columns = vars(toss_efficiency))
    ) %>%
    opt_footnote_marks(marks = "letters") %>% 
    # Styling
    # Subtitle
    tab_style(style = cell_text(align = "left", v_align = "bottom", size = px(16)),
              locations = list(cells_title("title"), cells_title("subtitle"))) %>% 
    # Title
    tab_style(
      style = list(cell_text(weight = "bold", size = px(18))),
      locations = cells_title(groups = "title")
    ) %>%
    tab_style(
      style = cell_text(v_align = "top", weight = 700, align = "left"),
      locations = cells_column_labels(everything())
    ) %>% 
    # Rank column
    tab_style(
      style = list(cell_text(weight = "bold")),
      locations = cells_body(
        columns = vars(rank)
      )
    ) %>% 
    cols_align(align = "right") %>% 
    cols_align(align = "left", columns = c("player_name", "rank")) %>% 
    # Left Align Player and Rank
    # Column widths
    cols_width(
      vars(rank) ~ px(20),
      vars(player_name) ~ px(90),
      vars(points_per_game) ~ px(80),
      vars(total_points, games_played, win_pct, total_shots) ~ px(48),
      vars(off_ppg, def_ppg, toss_efficiency) ~ px(75)
    ) %>% 
    # Underline dope shit
    tab_style(
      style = list(cell_text(weight = "bold"), cell_fill(color = "#FFD600", alpha = .8)),
      locations = list(
        # Most points
        cells_body(
          columns = vars(total_points),
          rows = total_points == max(total_points)
          ),
        # Highest ppg
        cells_body(
          columns = vars(points_per_game),
          rows = points_per_game == max(points_per_game)
        ),
        # Highest off ppg
        cells_body(
          columns = vars(off_ppg),
          rows = off_ppg == max(off_ppg)
        ),
        # Highest def ppg
        cells_body(
          columns = vars(def_ppg),
          rows = def_ppg == max(def_ppg)
        )
      )
    ) %>% 
    tab_theme_snappa(table.font.size = px(12))
  
}

```

```{r}
inner_join(players_tbl, tbl(con, "player_stats") %>% collect(), by = "player_id") %>%
  inner_join(select(game_stats_tbl, game_id, night_dice:points_b), by = "game_id") %>% 
  mutate(winners = if_else(points_a > points_b, "A", "B"),
         won_game = (team == winners)) %>% 
    select(-player_id) %>% 
    # Calculate leaderboard
    group_by(player_name) %>% 
    summarise(
      games_played = n(),
      win_pct = sum(won_game)/games_played,
      points_per_game = mean(total_points),
      total_points = sum(total_points),
      offensive_points = sum(off_ppr*shots),
      defensive_points = sum(def_ppr*shots),
      ones = sum(ones),
      twos = sum(twos),
      threes = sum(threes),
      paddle_points = sum(paddle_points),
      clink_points = sum(clink_points),
      total_shots = sum(shots),
      off_ppg = mean(off_ppr*shots),
      def_ppg = mean(def_ppr*shots),
      toss_efficiency = weighted.mean(toss_efficiency, w = shots)
    ) %>% 
    ungroup() %>% 
    filter_at(vars(-player_name), any_vars(!is.na(.))) %>% 
    mutate(rank = rank(-total_points)) %>% 
    select(rank, everything(), -offensive_points:-clink_points) %>% 
    arrange(rank) %>% 
  leaderboard_table()
```


```{r}

max_score = game_stats_tbl %>% 
  summarise(across(contains("points_"), ~max(.))) %>% 
  pull() %>% 
  max()

scores_tbl %>% 
  mutate(highlight_game = if_else(game_id == max(game_id), "max", "not")) %>% 
  arrange(game_id, score_id) %>% 
  rowwise() %>% 
  mutate(round = which(rounds == round_num)) %>% 
  ungroup() %>% 
  group_by(game_id) %>% 
  mutate(
    score_a = cumsum(str_detect(scoring_team, "[aA]")*points_scored),
    score_b = cumsum(str_detect(scoring_team, "[bB]")*points_scored),
    end_a = max(score_a),
    end_b = max(score_b)
  ) %>% 
    ungroup() %>% #filter(highlight_game == "max")
    ggplot(aes(x = score_b, y = score_a, group = game_id, colour = highlight_game))+
    geom_line()+
  geom_abline(slope = 1, intercept = 0, lty = "dashed", alpha = .7, colour = "grey42")+
    geom_point(aes(x = end_b, y = end_a))+
  scale_colour_manual(values = c("not" = "grey69", "max" = snappa_pal[2]), guide = NULL)+
  coord_cartesian(xlim = c(0, max_score), ylim = c(0, max_score))+
  labs(x = "Team B", y = "Team A")+
    theme_snappa(plots_pane = T, md=T)


```

## Score Heatmap

```{r}
score_heatmap = function(df){
  max_score = summarise_at(df, vars(starts_with("score")), max) %>% 
    pull() %>% 
    max()
  
  score_labels = seq_len(max_score + 1) - 1 
  score_labels[score_labels %% 2 == 0] = ""
  score_labels = score_labels %>% as.character()
  # Create helpers for the labels in the scale
  
  
  df %>% 
    ggplot(aes(x = score_b, y = score_a))+
    geom_tile(aes(fill = n), color = "black")+
    # Record the 45 degree line for visual reference
    geom_abline(mapping = NULL, data = NULL, slope = 1, intercept = 0) + 
    scale_fill_gradient(name = "Frequency", low = "#ffeda0", high = "#f03b20", na.value = "grey")+
    labs(x = "Team B",
         y = "Team A",
         title = "Heatmap of scores in Snappa")+
    coord_cartesian(xlim = c(1, max_score - 1),
                    ylim = c(1, max_score - 1)) +
    scale_x_continuous(breaks = seq.int(from = 0, to = max_score, by = 1), labels = score_labels) +
    scale_y_continuous(breaks = seq.int(from = 0, to = max_score, by = 1), labels = score_labels) +
    theme_snappa()
  
  
}
```

```{r}
scores_tbl %>% 
  arrange(game_id, score_id) %>% 
  group_by(game_id) %>% 
  mutate(
    score_a = cumsum((scoring_team=="A")*points_scored),
    score_b = cumsum((scoring_team=="B")*points_scored)
  ) %>% 
  ungroup() %>% 
  count(score_a, score_b) %>% 
  score_heatmap()
```



## Player performance over time

```{r}
player_stats_tbl %>% 
  # Join in player names
  inner_join(players_tbl) %>% 
  group_by(player_name) %>% 
  # Arrange by game_id to number each player's games
  arrange(player_id, game_id) %>% 
  mutate(game = 1:n(),
         games_played = max(game)) %>% 
  ungroup() %>% 
  # Filter the top 4 players by games played
  filter(dense_rank(-games_played) < 5) %>% 
  group_by(player_name, game_id) %>% 
  ggplot(., aes(x = game, y = total_points, colour = player_name))+
  geom_line()+
  scale_colour_manual(values = snappa_pal[4:7])+
  theme_snappa(plots_pane=T)
```


## Player performance distribution

```{r}
player_stats_tbl %>% 
  # Join in player names
  inner_join(players_tbl) %>% 
  group_by(player_name) %>% 
  # Arrange by game_id to number each player's games
  arrange(player_id, game_id) %>% 
  mutate(game = 1:n(),
         games_played = max(game),
         last_game_points = last(total_points),
         highlight_game = if_else(total_points == last_game_points, "max", "not")) %>% 
  ungroup() %>% 
  # Filter the top 4 players by games played
  filter(dense_rank(-games_played) < 5) %>% 
  ggplot(., aes(x = total_points, fill = highlight_game))+
  geom_histogram(binwidth = 1)+
  scale_y_continuous(name = NULL)+
  scale_fill_manual(values = c("not" = "grey69", "max" = snappa_pal[2]), guide = NULL)+
  facet_wrap(~player_name, ncol = 2)+
  theme_snappa(plots_pane = T, md = T)
  
```


# Game Summary



## Player Performance



```{r}
performance_df = player_stats_tbl %>% 
  select(-team) %>% 
  filter(game_id <= last_game) %>% 
  inner_join(select(player_info, player_id, player_name, team)) %>% 
  arrange(player_id, game_id) %>% 
  group_by(player_id) %>% 
  mutate(game_num = 1:n()) %>% 
  ungroup()

max_ppg = max(performance_df$total_points)

historical_performance = function(df){
  ggplot(df, aes(x = game_num, y = total_points, group = player_id))+
    geom_point(colour = "grey19")+
    geom_smooth(se=F, aes(colour = team), show.legend = F)+
    scale_y_continuous(name = "Points per Game", breaks = scales::pretty_breaks(), limits = c(0, max_ppg))+
    scale_x_continuous(name = "Games played", breaks = scales::pretty_breaks())+
    scale_colour_manual(values = c("A" = "#e26a6a", "B" = "#2574a9"))+
    # gghighlight(game_num == max(game_num), use_direct_label = F, calculate_per_facet = T, n = 1)+
    facet_wrap(~player_name, ncol = 1)+
    theme_snappa()
}

player_count = distinct(performance_df, team, player_id) %>% count(team) %>% deframe()

# rep(c("AA"), times = player_count)

pl = "AABB
      AABB
      ##BB"

group_split(performance_df, team) %>% 
  map(historical_performance) %>% 
  reduce(`+`)+
  plot_layout(guides = "collect", design = pl)
  
```

## Player points makeup

```{r}
player_score_breakdown = function(stats_df, players_df, team){
  if(team == "A"){
    team_margin = margin(0,-20,0,0)
  } else {
    team_margin = margin(0,0,0, -20)
  }
  reverse_legend = (!!team == "A")

  df = stats_df %>% 
    filter(game_id == max(game_id)) %>% 
    inner_join(players_df) %>% 
    filter(team == !!team) %>% 
    select(player_name, team, total_points:clink_points) %>% 
    arrange(-total_points) %>% 
    # Calculate sink points and "normal" points
    # NOTE: this is not correct. it currently double counts any paddle clinks/clink sinks/paddle sinks
    mutate(sink = threes*3,
           normal_toss = total_points-(paddle_points+clink_points+sink)) %>% 
    select(player_name, team, `Normal toss` = normal_toss, Paddle = paddle_points, Clink = clink_points, Sink = sink) %>% 
    # Pivot to get point type
    pivot_longer(cols = `Normal toss`:Sink, names_to = "point_type", values_to = "points") %>% 
    # Convert point type to factor
    mutate(point_type = factor(point_type, levels = c("Sink", "Clink", "Paddle", "Normal toss"), ordered = T)) %>% 
    group_by(player_name) %>%
    filter(points > 0) %>% 
    mutate(point_pct = points/sum(points))
  
  
  
    df %>%
      ggplot(., aes(y = player_name, x = points, fill = point_type))+
      # Bars
      geom_col(position = "fill", colour = snappa_pal[1], size = 1.5)+
      # Labels
      geom_text(data = filter(df, point_pct > .15), 
                aes(label = scales::percent(point_pct, accuracy = 1)), 
                position = position_fill(vjust = .5), colour = "white", show.legend = F)+
      # Y Axis
      scale_y_discrete(name = NULL, position = if_else(reverse_legend, "left", "right"))+
      # X Axis
      scale_x_continuous(name = NULL, labels = scales::percent)+
      # Colour scale
      scale_fill_manual(name = NULL, drop=F,
                        values = c("Normal toss" = "#67A283", "Paddle" = "#793E8E", "Clink" = "#54B6F2", "Sink" = "#FFA630" ),
                        guide = guide_legend(reverse = T, label.hjust = 0.5, nrow = 2, byrow = T))+
      # Theme elements
      theme_snappa(md=T, plot_margin = team_margin, base_size = 11)+
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_blank(),
        legend.position = "bottom",
        legend.margin = margin(0,-30,0,-30),
        legend.text.align = .5,
        axis.text.x = element_blank(),
        axis.text.y.left = element_text(margin = margin(l = -5, r = -5), hjust = 1),
        axis.text.y.right = element_text(margin = margin(l = -5, r = -5), hjust = 0)
      )
}


```

```{r}
test_df = player_stats_tbl %>% 
    filter(game_id == max(game_id)) %>% 
    inner_join(player_info) %>% 
    filter(team == "A") %>% 
    select(player_name, team, total_points:clink_points) %>% 
    arrange(-total_points) %>% 
    # Calculate sink points and "normal" points
    # NOTE: this is not correct. it currently double counts any paddle clinks/clink sinks/paddle sinks
    mutate(sink = threes*3,
           normal_toss = total_points-(paddle_points+clink_points+sink)) %>% 
    select(player_name, team, `Normal toss` = normal_toss, Paddle = paddle_points, Clink = clink_points, Sink = sink) %>% 
    # Pivot to get point type
    pivot_longer(cols = `Normal toss`:Sink, names_to = "point_type", values_to = "points") %>% 
    # Convert point type to factor
    mutate(point_type = factor(point_type, levels = c("Normal toss", "Paddle", "Clink", "Sink"), ordered = T)) %>% 
    group_by(player_name) %>%
    filter(points > 0) %>% 
    mutate(point_pct = points/sum(points))

test_df$point_type
reorder(test_df$point_type, desc(test_df$point_type))

```

```{r}
player_score_breakdown(player_stats_tbl, player_info, "A")
```


```{r}



a_breakdown = player_stats_tbl %>% 
  # Select the last game
  filter(game_id == max(game_id), team == "A") %>% 
  # Merge in player info
  inner_join(player_info) %>% 
  select(player_name, team, total_points:clink_points) %>% 
  arrange(-total_points) %>% 
  mutate(sink = threes*3,
         normal_toss = total_points-(paddle_points+clink_points+sink)) %>% 
  select(player_name, team, `Normal toss` = normal_toss, Paddle = paddle_points, Clink = clink_points, Sink = sink) %>% 
  pivot_longer(cols = `Normal toss`:Sink, names_to = "point_type", values_to = "points") %>% 
  mutate(point_type = factor(point_type, levels = c("Normal toss", "Paddle", "Clink", "Sink"), ordered = T)) %>%
  group_by(player_name) %>%
  filter(points > 0) %>% 
  mutate(point_pct = scales::percent(points/sum(points), accuracy = 1)) %>%
  ggplot(., aes(y = player_name, x = points, fill = reorder(point_type, desc(point_type))))+
  # Bars
  geom_col(position = "fill", colour = snappa_pal[1], size = 3)+
  # Labels
  geom_text(aes(label = point_pct), 
            position = position_fill(vjust = .5), colour = "white", show.legend = F)+
  # {if(Switch)geom_hline(yintercept=15)}+
  # Y Axis
  scale_y_discrete(name = NULL, position = "left")+
  # X Axis
  scale_x_continuous(name = NULL, labels = scales::percent)+
  # Colour scale
  scale_fill_manual(name = NULL, 
                    values = c("Normal toss" = "#67A283", "Paddle" = "#793E8E", "Clink" = "#54B6F2", "Sink" = "#FFA630" ),
                    guide = guide_legend(reverse=T, label.hjust = 0.5))+
  # Theme elements
  theme_snappa(plots_pane = T, md=T, plot_margin = margin(0,0,0,0))+
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_blank(),
    legend.position = "bottom",
    legend.margin = margin(0,0,0,-30),
    legend.text.align = -.5,
    axis.text.x = element_blank(),
    axis.text.y.left = element_text(margin = margin(l = -5, r = -5), hjust = 1),
    axis.text.y.right = element_text(margin = margin(l = -5, r = -5), hjust = 0)
  )

b_breakdown = player_stats_tbl %>% 
  # Select the last game
  filter(game_id == max(game_id), team == "B") %>% 
  # Merge in player info
  inner_join(player_info) %>% 
  select(player_name, team, total_points:clink_points) %>% 
  arrange(-total_points) %>% 
  mutate(sink = threes*3,
         normal_toss = total_points-(paddle_points+clink_points+sink)) %>% 
  select(player_name, team, `Normal toss` = normal_toss, Paddle = paddle_points, Clink = clink_points, Sink = sink) %>% 
  pivot_longer(cols = `Normal toss`:Sink, names_to = "point_type", values_to = "points") %>% 
  mutate(point_type = factor(point_type, levels = c("Normal toss", "Paddle", "Clink", "Sink"), ordered = T)) %>%
  group_by(player_name) %>%
  filter(points > 0) %>% 
  mutate(point_pct = scales::percent(points/sum(points), accuracy = 1)) %>%
  ggplot(., aes(y = player_name, x = points, fill = reorder(point_type, desc(point_type))))+
  # Bars
  geom_col(position = "fill", colour = snappa_pal[1], size = 3)+
  # Labels
  geom_text(aes(label = point_pct), 
            position = position_fill(vjust = .5), colour = "white", show.legend = F)+
  # {if(Switch)geom_hline(yintercept=15)}+
  # Y Axis
  scale_y_discrete(name = NULL, position = "right")+
  # X Axis
  scale_x_continuous(name = NULL, labels = scales::percent)+
  # Colour scale
  scale_fill_manual(name = NULL, 
                    values = c("Normal toss" = "#67A283", "Paddle" = "#793E8E", "Clink" = "#54B6F2", "Sink" = "#FFA630" ),
                    guide = guide_legend(reverse=F, label.hjust = 0.5))+
  # Theme elements
  theme_snappa(plots_pane = T, md=T, plot_margin = margin(0,0,0,0))+
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_blank(),
    legend.position = "bottom",
    legend.margin = margin(0,0,0,-30),
    legend.text.align = -.5,
    axis.text.x = element_blank(),
    axis.text.y.left = element_text(margin = margin(l = -5, r = -5), hjust = 1),
    axis.text.y.right = element_text(margin = margin(l = -5, r = -5), hjust = 0)
  )

a_breakdown
```


```{r}
(wrap_elements(full = a_breakdown /
                plot_spacer() / 
                plot_spacer()*
                theme(plot.background = element_rect(fill = snappa_pal[1], colour = snappa_pal[1]))*
                plot_annotation(theme = theme(plot.background = element_rect(fill = snappa_pal[1], colour = snappa_pal[1]))))+
  game_flow_plot+
  theme_snappa(plots_pane = T, md = T)+
  wrap_elements(full = b_breakdown /
                    plot_spacer() /
                    plot_spacer()*
                  theme(plot.background = element_rect(fill = snappa_pal[1], colour = snappa_pal[1]))*
                  plot_annotation(theme = theme(plot.background = element_rect(fill = snappa_pal[1], colour = snappa_pal[1])))))+
  plot_layout(widths = c(3,5,3))
```




## Recent Scores

```{r}
scores_tbl %>% 
  filter(game_id == last_game) %>% 
  top_n(., 5, score_id) %>% 
      arrange(-score_id) %>% 
      left_join(select(player_info, player_id, player_name)) %>% 
  # mutate(scored = "scored",
  #        points = if_else(points_scored > 1, "points", "point"),
  #        for_team = str_c("for Team", scoring_team),
  #        in_round = str_c("in round", round_num),
  #        )
    # group_by(score_id) %>% 
    mutate(colour = if_else(scoring_team == "A", snappa_pal[2], snappa_pal[3]),
           scorer = str_c("<span style = 'font-weight: 600;color:", 
                          colour, ";'>",
                          player_name, "</span>"), 
           points = str_c(" scored <span style='font-weight: 600;'>",
                          points_scored,
                          if_else(points_scored > 1, " points", " point"), "</span>",
                          na.omit(if_else(clink, " with a clink", NA_character_)), " for"),
           when_scored= str_c(" in round <span style = 'font-weight: 600;'>", round_num, "</span>"),
           for_whom = str_c(" <span style = 'font-weight: 600;color:", 
                          colour, ";'>", "Team ", toupper(scoring_team), "</span>"),
           special = str_c(
               if_else(paddle, str_c(" and it was a", 
                                     na.omit(
                                       if_else(foot, " foot", NA_character_)), " paddle!"), NA_character_
                     )
             ),
           sentence = str_c(scorer, points, for_whom, when_scored, if_else(is.na(special), "", special))
           ) %>% 
    select(sentence) %>% 
  gt() %>% 
  fmt_markdown(vars(sentence)) %>% 
  # fmt_missing(vars(special), missing_text = "") %>%
  # cols_align(columns = vars(scorer), align = "right") %>% 
      tab_theme_snappa() %>% 
      tab_options(column_labels.hidden = T)
```



# Imbalanced teams

How do teams perform in cases when the teams are 3v2?

First we need to get a count of players for each time.

```{r}
player_count = player_stats_tbl %>% 
  # Count the numbers of players for each team
  add_count(game_id, team, name = "players") %>% 
  group_by(game_id) %>% 
  # Select games where the total players is uneven
  filter(sum(players) %% 2 > 0) %>% 
  ungroup() %>% 
  arrange(game_id) %>% 
  # Select unique combinations of game, team and the player count
  distinct(game_id, team, players) %>% 
  # Pivot to a column for each team's player count
  pivot_wider(id_cols = game_id, names_from = "team", names_prefix = "Team", values_from = "players")

player_count
```

Now we want to know how often the team with fewer players wins games

```{r}
game_stats_tbl %>% 
  filter(num_players %% 2 > 0) %>% 
  inner_join(player_count) %>% 
  select(game_id, points_a, points_b, rounds, TeamA, TeamB) %>% 
  mutate(lower_team_wins = case_when((TeamA < TeamB & points_a > points_b) ~ T,
                                     (TeamA > TeamB & points_a < points_b) ~ T,
                                     T ~ F)) %>% 
  count(lower_team_wins)
```

